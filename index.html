<!DOCTYPE html>

<html>
<head>
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="-1">

  <title> NaCl Hello World in C++ </title>
<style>
#a1 {
    position:absolute;
    z-index: 300;
    right:0;
    top:40px;
}
    body {
      background-color: white;
      margin: 25px;
    }

    code {
      font: 110% consolas, monospace;
    }

    h2 {
      font-size: 135%;
    }

    p {
      font-size: 120%;
    }

    textarea {
      font-size: 120%;
    }
  </style>
</head>
<body>
  <h2>Status: <code id="status">Loading</code></h2>
  
  <h2>NaCl messages:</h2>
  
  <div id="listener">

  </div>
  <div id="a1"></div>
	<p id="nacl_output"> </p>
	  <div id="logs_area">
    <h2>NaCl messages: </h2>
    <textarea id="logs" rows="20" cols="80" readonly></textarea>
    <textarea id="logs2" rows="20" cols="80" readonly></textarea>
  </div>
  <script>

var kLibAvPrefix = "LIBAV:";
var kLogPrefix = "LOG:";
var kInfoPrefix = "INFO:";
var kErrorPrefix = "ERROR:";
var kDebugPrefix = "DEBUG:";
  
  var ptsDiv = document.getElementById("a1");
  var listenerDiv = document.getElementById("listener");
  var logs = document.getElementById("logs");
  var logs2 = document.getElementById("logs2");
  
  var demo_name = 'Native Player';
var demo_description = '';
var nmf_path_name = 'CurrentBin/hello_world_cpp.nmf';
var nacl_width = 640;
var nacl_height = 480;
  var uses_logging = true;
  
  var x = 0;
  var b = 0;
  
  var logI = 0;
    var logI2 = 0;
    
  function startsWith(s, prefix) {
  return s.indexOf(prefix) === 0;
}
  
  function printIfLog(message) {
  if (typeof message == "string") 
  {
          if(startsWith(message, kLogPrefix) || startsWith(message, kErrorPrefix) || startsWith(message, kInfoPrefix)
           || startsWith(message, kDebugPrefix)) {
    if(logI > 200)
    {
	    logs.value = message;
	    logI = 0;
    }
    else
    {  
    	logI++;
     	logs.value += message;
     }
    logs.scrollTop = logs.scrollHeight;
    return true;
  }
            if(startsWith(message, kLibAvPrefix)) {
    if(logI2 > 200)
    {
	    logs2.value = message;
	    logI2 = 0;
    }
    else
    {  
    	logI2++;
     	logs2.value += message;
     }
    logs2.scrollTop = logs2.scrollHeight;
    return true;
  }
  }
  return false;
}
  
  /* Handles messages sent from NaCl app by PostMessage(). */
  function handleMessage(message) {
    if (printIfLog(message.data)) {  // function defined in common.js
    return;   // this was a log or error message, so we can finish this handling
  }
  if(typeof message.data === 'string' && message.data.includes("pts"))
  {
  if(b < 50)
  {
  	document.getElementById("a1").innerHTML += message.data +"<br />";
  	b++;
  	}
  }
  else
  {
  /*
  if(x < 30)
  {
  	document.getElementById("nacl_output").innerHTML += message.data +"<br />";
  }
  else
  {
      document.getElementById("nacl_output").innerHTML = message.data +"<br />";
      x = 0;
  }
  x++;
  */
  }
  }
  
  /* An utility function. */
  function updateStatus(txt_message) {
    document.getElementById("status").innerHTML = txt_message;
  }
 
  
  
  function createNaclModule(nmf_path_name, width, height) {
  var nacl_elem = document.createElement("embed");
  nacl_elem.setAttribute("name", "nacl_module");
  nacl_elem.setAttribute("id", "nacl_module");
  nacl_elem.setAttribute("type", "application/x-nacl");
  nacl_elem.setAttribute("src", nmf_path_name);
  nacl_elem.setAttribute("width", width);
  nacl_elem.setAttribute("height", height);
  //nacl_elem.setAttribute("logs", logs_level);

  //var listenerDiv = document.getElementById("listener");
  listenerDiv.appendChild(nacl_elem);
  
var nacl_module = document.getElementById("nacl_module");

  function handleCrash(event) {
    updateStatus("Crashed/exited with status: " + nacl_module.exitStatus);
  }

  function handleLoad(event) {
    updateStatus("Loaded");
    nacl_module.postMessage("Hello World from JS");
  }

  // attach common listeners
  //listenerDiv.addEventListener("message", handleNaclMessage, true);
  //listenerDiv.addEventListener("crash", handleNaclCrash, true);
  //listenerDiv.addEventListener("load", handleNaclLoad, true);
  
  listenerDiv.addEventListener("message", handleMessage, true);
  listenerDiv.addEventListener("load", handleLoad, true);
  listenerDiv.addEventListener("crash", handleCrash, true);
}
  
  /* Here we bind events specific for an "application/x-nacl" type embed element.
  For more info see:
  https://developer.chrome.com/native-client/devguide/coding/progress-events .*/

  
  document.addEventListener("DOMContentLoaded", function() {
  
  createNaclModule(nmf_path_name, nacl_width, nacl_height);
  updateStatus("Loading...");
  
  });
  </script>
</body>
</html>
